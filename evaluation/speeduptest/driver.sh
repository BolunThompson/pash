#!/bin/bash
# Generates an executable script for running all parallel experiments
# ./driver.sh [parallelism_factor]

set -e

CPUs=${1:-$(nproc)}
IN=${IN:-../scripts/input/10M.txt}
OUT=${OUT:-./out.txt}
SEQ=${2:-"./seq-grep"}

# divide by number of chunks in AWK
total_size=$(wc -l $IN | awk -F " " '{print $1}') 
chunk_size=$((total_size / CPUs))
split -l $chunk_size $IN dish-chunk-

echo '#!/bin/bash' > dish-execute.sh
chmod +x ./dish-execute.sh
echo "# This script is auto-generated by driver.sh" >> dish-execute.sh
echo "#seq script: time (cat $IN | $SEQ > $OUT)" >> dish-execute.sh

# echo "set -x" >> dish-execute.sh

counter=0
for chunk in dish-chunk-*; do
  echo "mkfifo dish-fifo-$((counter++))" >> dish-execute.sh
done

counter=0
for chunk in dish-chunk-*; do
  echo "cat $chunk | $SEQ > dish-fifo-$((counter++)) &" >> dish-execute.sh
done

#FIXME: bash doesn't expand `*` in _numberic_ order (1, 10, 2..) affecting cat
echo cat 'dish-fifo-* >' $OUT >> dish-execute.sh 

echo "# Delete all pipes" >> dish-execute.sh
counter=0
for chunk in dish-chunk-*; do
  echo "find .  -maxdepth 1 -type p -delete -name 'dish-fifo-$((counter++))'" >> dish-execute.sh
done

time (cat $IN | $SEQ > $OUT)
time ./dish-execute.sh
